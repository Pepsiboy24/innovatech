<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timetable Management - EduHubAdmin</title>
    <link rel="stylesheet" href="../../styles/schoolAdminStyles/timeTable.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="sidebar" data-sideBar>
        <div class="logo">
            <div style="display: flex; align-items: center; gap: 10px;">
                <div class="logo-icon"><i class="fa-solid fa-calendar-days"></i></div>
                <span>EduHubAdmin</span>
            </div>
            <div class="icon" data-sideBarClose><i class="fa fa-times"></i></div>
        </div>
        <nav>
            <a href="./schoolAdminDashboard.html" class="nav-item">
                <i class="fa-solid fa-table-columns nav-icon"></i>
                Dashboard
            </a>
            <a href="./classes.html" class="nav-item sidebar-item">
                <i class="fa-solid fa-chalkboard-user nav-icon"></i>
                <span>Classes</span>
            </a>
            <a href="./students.html" class="nav-item">
                <i class="fa-solid fa-user-graduate nav-icon"></i>
                Students
            </a>
            <a href="./teachers.html" class="nav-item">
                <i class="fa-solid fa-chalkboard-teacher nav-icon"></i>
                Teachers
            </a>
            <a href="./subjects.html" class="nav-item">
                <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                    style="width: 18px; height: 18px;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253">
                    </path>
                </svg>
                <span>Subjects</span>
            </a>
            <a href="./schedule.html" class="nav-item">
                <i class="fa-regular fa-calendar nav-icon"></i>
                Schedule
            </a>
            <a href="#" class="nav-item active">
                <i class="fa-solid fa-clock nav-icon"></i>
                Time Table
            </a>
            <a href="#" class="nav-item">
                <i class="fa-solid fa-clipboard-user nav-icon"></i>
                Attendance
            </a>
            <a href="#" class="nav-item">
                <i class="fa-solid fa-money-bill-wave nav-icon"></i>
                Fees
            </a>
        </nav>
    </div>

    <div class="main">
        <div class="header">
            <div class="header-left">
                <div class="icon mobile-menu-btn" data-sideBarOpen><i class="fa fa-bars"></i></div>
                <div>
                    <h1 class="page-title">Timetable Management</h1>
                    <p class="page-subtitle">Manage class schedules and events</p>
                </div>
            </div>
        </div>

        <div class="toolbar">
            <button class="btn btn-primary" onclick="window.location.href='./create_timetable_setup.html'">
                <i class="fa-solid fa-plus"></i> Create New Timetable
            </button>
            <button class="btn active" onclick="filterTimetables('all')">All Timetables</button>
            <button class="btn" onclick="filterTimetables('week')">Current Week</button>
        </div>

        <div class="timetables-grid" id="timetablesGrid">
            <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #666;">
                <i class="fa-solid fa-spinner fa-spin"></i> Loading timetables...
            </div>
        </div>
    </div>

    <!-- Edit Timetable Modal -->
    <div id="editTimetableModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Timetable Configuration</h2>
                <button class="modal-close" onclick="closeEditModal()">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="editTimetableForm">
                    <div class="form-section">
                        <h3>Class Information</h3>
                        <div class="form-group">
                            <label>Class:</label>
                            <input type="text" id="editClassName" readonly>
                            <input type="hidden" id="editClassId">
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Time Settings</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editStartTime">Start Time *</label>
                                <input type="time" id="editStartTime" required>
                            </div>
                            <div class="form-group">
                                <label for="editEndTime">School End Time *</label>
                                <input type="time" id="editEndTime" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editPeriodDuration">Period Duration (minutes) *</label>
                                <input type="number" id="editPeriodDuration" min="15" max="120" required>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Active Days</h3>
                        <div class="days-selection">
                            <label class="day-checkbox">
                                <input type="checkbox" name="editActiveDays" value="Mon">
                                <span>Monday</span>
                            </label>
                            <label class="day-checkbox">
                                <input type="checkbox" name="editActiveDays" value="Tue">
                                <span>Tuesday</span>
                            </label>
                            <label class="day-checkbox">
                                <input type="checkbox" name="editActiveDays" value="Wed">
                                <span>Wednesday</span>
                            </label>
                            <label class="day-checkbox">
                                <input type="checkbox" name="editActiveDays" value="Thu">
                                <span>Thursday</span>
                            </label>
                            <label class="day-checkbox">
                                <input type="checkbox" name="editActiveDays" value="Fri">
                                <span>Friday</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Break Times</h3>
                        <div id="editBreaksContainer">
                            <!-- Breaks will be populated here -->
                        </div>
                        <button type="button" class="btn btn-secondary" onclick="addEditBreakField()">
                            <i class="fa-solid fa-plus"></i>
                            Add Break
                        </button>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
    <button type="button" class="btn-secondary" onclick="closeEditModal()">Cancel</button>
    <button type="button" class="btn btn-primary" onclick="saveTimetableChanges()">
        <i class="fa-solid fa-save"></i> Save Changes
    </button>
</div>
        </div>
    </div>

    <!-- Edit Entry Modal -->
    <div id="editEntryModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Timetable Entry</h2>
                <button class="modal-close" onclick="closeEditEntryModal()">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="editEntryForm">
                    <div class="form-section">
                        <h3>Entry Details</h3>
                        <div class="form-group">
                            <label for="editEntryDay">Day:</label>
                            <input type="text" id="editEntryDay" readonly>
                        </div>
                        <div class="form-group">
                            <label for="editEntryTime">Time:</label>
                            <input type="text" id="editEntryTime" readonly>
                        </div>
                        <div class="form-group">
                            <label for="editEntrySubject">Subject *</label>
                            <select id="editEntrySubject" required>
                                <option value="">-- Select Subject --</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeEditEntryModal()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveEntryChanges()">
                    <i class="fa-solid fa-save"></i> Save Entry
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

        // 1. CONFIGURATION
        const SUPABASE_URL = "https://dzotwozhcxzkxtunmqth.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR6b3R3b3poY3h6a3h0dW5tcXRoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwODk5NzAsImV4cCI6MjA3MDY2NTk3MH0.KJfkrRq46c_Fo7ujkmvcue4jQAzIaSDfO3bU7YqMZdE";
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Global State
        let globalData = {
            classes: [],
            subjects: [],
            configs: [],
            entries: []
        };

        // 2. INITIALIZATION
        document.addEventListener('DOMContentLoaded', loadAllTimetableData);

        // 3. FETCH DATA
        async function loadAllTimetableData() {
            try {
                // Fetch all necessary tables in parallel
                const [configs, classes, subjects, entries] = await Promise.all([
                    supabase.from('schedule_configs').select('*'),
                    supabase.from('Classes').select('*'),
                    supabase.from('Subjects').select('*'),
                    supabase.from('timetable_entries').select('*')
                ]);

                if (configs.error) throw configs.error;
                
                // Store in global state
                globalData.configs = configs.data || [];
                globalData.classes = classes.data || [];
                globalData.subjects = subjects.data || [];
                globalData.entries = entries.data || [];

                renderTimetables();

            } catch (error) {
                console.error("Error loading data:", error);
                document.getElementById('timetablesGrid').innerHTML = 
                    `<div style="color: red; text-align: center;">Error loading timetables: ${error.message}</div>`;
            }
        }

        // 4. RENDER LOGIC
        function renderTimetables() {
            const container = document.getElementById('timetablesGrid');
            container.innerHTML = ''; // Clear loading spinner

            if (globalData.configs.length === 0) {
                container.innerHTML = '<div style="text-align: center;">No timetables found. Create one to get started!</div>';
                return;
            }

            // Loop through each "Config" (which represents one Class's schedule)
            globalData.configs.forEach(config => {
                const classInfo = globalData.classes.find(c => c.class_id === config.class_id);
                const classEntries = globalData.entries.filter(e => e.class_id === config.class_id);
                
                // Generate the HTML for this specific card
                const cardHTML = createTimetableCard(config, classInfo, classEntries);
                container.insertAdjacentHTML('beforeend', cardHTML);
            });
        }

        // 5. CARD GENERATOR
        function createTimetableCard(config, classInfo, entries) {
            const className = classInfo ? `${classInfo.class_name} ${classInfo.section || ''}` : `Class ${config.class_id}`;
            const subtitle = classInfo ? `Grade ${classInfo.grade_level || ''} â€¢ Room ${classInfo.room_number || 'TBD'}` : 'Schedule';

            // Generate time rows based on start_time and duration
            const rowsHTML = generateTimeRows(config, entries);

            return `
                <div class="timetable-card">
                    <div class="timetable-header">
                        <h3 class="timetable-title">${className}</h3>
                        <p class="timetable-subtitle">${subtitle}</p>
                    </div>
                    <div class="schedule-grid">
                        <table class="timetable-table">
                            <thead>
                                <tr>
                                    <th class="time-column">Time</th>
                                    <th class="day-column">Mon</th>
                                    <th class="day-column">Tue</th>
                                    <th class="day-column">Wed</th>
                                    <th class="day-column">Thu</th>
                                    <th class="day-column">Fri</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${rowsHTML}
                            </tbody>
                        </table>
                    </div>
                    <div class="card-footer">
                        <button class="btn-view" onclick="viewFullTimetable('${config.class_id}')">View Full</button>
                        <button class="btn-edit" onclick="openEditModal('${config.class_id}')">
    <i class="fa-solid fa-pen"></i>
</button>
                    </div>
                </div>
            `;
        }

        // 6. DYNAMIC ROW GENERATOR
        function generateTimeRows(config, entries) {
            let html = '';
            
            // Default to 8 periods if not specified
            const periodsCount = config.periods_per_day || 8;
            const duration = config.period_duration || 40;
            
            // Parse Start Time (e.g., "08:00:00")
            let [startHour, startMin] = (config.start_time || "08:00").split(':').map(Number);
            let currentMinutes = startHour * 60 + startMin;

            // Generate a row for each period
            for (let i = 0; i < periodsCount; i++) {
                // Calculate time string (e.g., "08:00")
                const timeStr = minutesToTimeString(currentMinutes);
                
                // Generate cells for Mon-Fri
                const daysHTML = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'].map(day => {
                    return generateCell(day, timeStr, entries);
                }).join('');

                html += `
                    <tr class="time-row">
                        <td class="time-cell">${timeStr}</td>
                        ${daysHTML}
                    </tr>
                `;

                // Increment time
                currentMinutes += duration;
                
                // Optional: Add break logic here if you store breaks in DB
                if (i === 3) currentMinutes += 20; // Example: 20 min break after 4th period
            }
            return html;
        }

        // 7. CELL GENERATOR
        function generateCell(day, timeStr, entries) {
            // Find entry for this Day and Time
            // Note: We use startsWith because DB time might be "08:00:00" and calc time is "08:00"
            const entry = entries.find(e =>
                e.day_of_week === day &&
                e.start_time.startsWith(timeStr)
            );

            if (entry) {
                // Find Subject Code
                const subject = globalData.subjects.find(s => s.subject_id === entry.subject_id);
                const code = subject ? (subject.subject_code || subject.subject_name.substring(0,3).toUpperCase()) : '???';

                // Color coding based on subject (optional hash function)
                return `<td class="subject-cell" onclick="openEditEntryModal('${day}', '${timeStr}', '${entry.class_id}')" data-day="${day}" data-time="${timeStr}" data-class="${entry.class_id}">
                            <span class="subject-block" data-subject="${code}">${code}</span>
                        </td>`;
            } else {
                return `<td class="empty-cell" onclick="openEditEntryModal('${day}', '${timeStr}', '${entries[0]?.class_id || ''}')" data-day="${day}" data-time="${timeStr}" data-class="${entries[0]?.class_id || ''}"></td>`;
            }
        }

        // Helper: Convert minutes (480) to "08:00"
        function minutesToTimeString(totalMinutes) {
            const h = Math.floor(totalMinutes / 60);
            const m = totalMinutes % 60;
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
        }

        // --- EXPOSE FUNCTIONS TO WINDOW FOR BUTTONS ---
        window.editTimetable = (classId) => {
            window.location.href = `./create_timetable_setup.html?classId=${classId}`;
        };

        window.viewFullTimetable = (classId) => {
            alert(`View full details for Class ID: ${classId} (Feature coming soon)`);
        };
        
        // Sidebar Toggle
        const sidebar = document.querySelector('[data-sideBar]');
        const sidebarOpenBtn = document.querySelector('[data-sideBarOpen]');
        const sidebarCloseBtn = document.querySelector('[data-sideBarClose]');

        if (sidebarOpenBtn && sidebar) {
            sidebarOpenBtn.addEventListener('click', () => sidebar.classList.add('show'));
        }
        if (sidebarCloseBtn && sidebar) {
            sidebarCloseBtn.addEventListener('click', () => sidebar.classList.remove('show'));
        }
        // --- MODAL LOGIC ---

window.openEditModal = (classId) => {
    const config = globalData.configs.find(c => c.class_id == classId);
    const classInfo = globalData.classes.find(c => c.class_id == classId);

    if (!config) return;

    // Helper to format "08:00:00" to "08:00" for HTML inputs
    const cleanTime = (timeStr) => timeStr ? timeStr.substring(0, 5) : "";

    // 1. Fill basic info
    document.getElementById('editClassId').value = classId;
    document.getElementById('editClassName').value = classInfo ? classInfo.class_name : 'Unknown';
    document.getElementById('editStartTime').value = cleanTime(config.start_time);
    document.getElementById('editPeriodDuration').value = config.period_duration;

    // 2. Fix: Get School End Time directly from config if it exists
    if (config.end_time) {
        document.getElementById('editEndTime').value = cleanTime(config.end_time);
    } else {
        // Fallback calculation if DB field is empty
        const periods = config.periods_per_day || 8;
        const dur = config.period_duration || 40;
        let [h, m] = (config.start_time || "08:00").split(':').map(Number);
        let totalMins = (h * 60) + m + (periods * dur) + 20; // +20 for break
        document.getElementById('editEndTime').value = minutesToTimeString(totalMins);
    }

    // 3. Handle Checkboxes
    const activeDays = config.active_days || [];
    document.querySelectorAll('input[name="editActiveDays"]').forEach(cb => {
        cb.checked = activeDays.includes(cb.value);
    });

    // 4. Populate breaks with corrected HTML structure
    const container = document.getElementById('editBreaksContainer');
    container.innerHTML = ''; 
    
    // Logic: If you have a breaks table, fetch from there. 
    // Otherwise, generate the default break:
    const dur = config.period_duration || 40;
    let [h, m] = (config.start_time || "08:00").split(':').map(Number);
    let breakStart = (h * 60) + m + (4 * dur); // After 4 periods
    
    addEditBreakField(minutesToTimeString(breakStart), 20);

    document.getElementById('editTimetableModal').style.display = 'flex';
};

window.closeEditModal = () => {
    document.getElementById('editTimetableModal').style.display = 'none';
};

window.saveTimetableChanges = async () => {
    const classId = document.getElementById('editClassId').value;
    const startTime = document.getElementById('editStartTime').value;
    const endTime = document.getElementById('editEndTime').value;
    const duration = document.getElementById('editPeriodDuration').value;
    
    // Collect selected days
    const selectedDays = Array.from(document.querySelectorAll('input[name="editActiveDays"]:checked'))
                             .map(cb => cb.value);

    try {
        const { error } = await supabase
            .from('schedule_configs')
            .update({
                start_time: startTime,
                end_time: endTime,
                period_duration: parseInt(duration),
                active_days: selectedDays // Ensure this column exists in your DB
            })
            .eq('class_id', classId);

        if (error) throw error;

        alert('Timetable updated successfully!');
        closeEditModal();
        loadAllTimetableData(); // Refresh the grid
    } catch (err) {
        console.error("Update error:", err);
        alert("Failed to update: " + err.message);
    }
};

// Break logic (Optional UI helper)
window.addEditBreakField = (time = '', duration = '') => {
    const container = document.getElementById('editBreaksContainer');
    const div = document.createElement('div');
    div.className = 'break-entry-row';
    div.innerHTML = `
        <div class="form-group">
            <label style="font-size: 11px; color: #64748b;">Start Time</label>
            <input type="time" class="break-start" value="${time}">
        </div>
        <div class="form-group">
            <label style="font-size: 11px; color: #64748b;">Duration (Mins)</label>
            <input type="number" class="break-duration" value="${duration}">
        </div>
        <button type="button" class="btn-remove-break" onclick="this.parentElement.remove()">
            <i class="fa fa-trash"></i>
        </button>
    `;
    container.appendChild(div);
};

// --- ENTRY EDITING LOGIC ---
window.openEditEntryModal = (day, time, classId) => {
    if (!classId) {
        alert('No class selected for this timetable.');
        return;
    }

    // Set day and time
    document.getElementById('editEntryDay').value = day;
    document.getElementById('editEntryTime').value = time;

    // Populate subject dropdown
    const subjectSelect = document.getElementById('editEntrySubject');
    subjectSelect.innerHTML = '<option value="">-- Select Subject --</option>';
    globalData.subjects.forEach(subject => {
        const option = document.createElement('option');
        option.value = subject.subject_id;
        option.textContent = `${subject.subject_code || subject.subject_name} - ${subject.subject_name}`;
        subjectSelect.appendChild(option);
    });

    // Find existing entry
    const existingEntry = globalData.entries.find(e =>
        e.class_id == classId &&
        e.day_of_week === day &&
        e.start_time.startsWith(time)
    );

    if (existingEntry) {
        subjectSelect.value = existingEntry.subject_id;
    } else {
        subjectSelect.value = '';
    }

    // Store classId for saving
    document.getElementById('editEntryForm').dataset.classId = classId;

    document.getElementById('editEntryModal').style.display = 'flex';
};

window.closeEditEntryModal = () => {
    document.getElementById('editEntryModal').style.display = 'none';
};

window.saveEntryChanges = async () => {
    const classId = document.getElementById('editEntryForm').dataset.classId;
    const day = document.getElementById('editEntryDay').value;
    const time = document.getElementById('editEntryTime').value;
    const subjectId = document.getElementById('editEntrySubject').value;

    try {
        if (subjectId) {
            // Upsert entry
            const { error } = await supabase
                .from('timetable_entries')
                .upsert({
                    class_id: classId,
                    day_of_week: day,
                    start_time: time + ':00', // Add seconds
                    subject_id: subjectId
                }, {
                    onConflict: 'class_id,day_of_week,start_time'
                });

            if (error) throw error;
        } else {
            // Delete entry if no subject selected
            const { error } = await supabase
                .from('timetable_entries')
                .delete()
                .eq('class_id', classId)
                .eq('day_of_week', day)
                .like('start_time', time + '%');

            if (error) throw error;
        }

        alert('Entry updated successfully!');
        closeEditEntryModal();
        loadAllTimetableData(); // Refresh the grid
    } catch (err) {
        console.error("Save error:", err);
        alert("Failed to save: " + err.message);
    }
};
    </script>
</body>
</html>