<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timetable Management - EduHubAdmin</title>
    <link rel="stylesheet" href="../../styles/schoolAdminStyles/timeTable.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="sidebar" data-sideBar>
        <div class="logo">
            <div style="display: flex; align-items: center; gap: 10px;">
                <div class="logo-icon"><i class="fa-solid fa-calendar-days"></i></div>
                <span>EduHubAdmin</span>
            </div>
            <div class="icon" data-sideBarClose><i class="fa fa-times"></i></div>
        </div>
        <nav>
            </nav>
    </div>

    <div class="main">
        <div class="header">
            <div class="header-left">
                <div class="icon mobile-menu-btn" data-sideBarOpen><i class="fa fa-bars"></i></div>
                <div>
                    <h1 class="page-title">Timetable Management</h1>
                    <p class="page-subtitle">Manage class schedules and events</p>
                </div>
            </div>
        </div>

        <div class="toolbar">
            <button class="btn btn-primary" onclick="window.location.href='./create_timetable_setup.html'">
                <i class="fa-solid fa-plus"></i> Create New Timetable
            </button>
            <button class="btn active" onclick="filterTimetables('all')">All Timetables</button>
            <button class="btn" onclick="filterTimetables('week')">Current Week</button>
        </div>

        <div class="timetables-grid" id="timetablesGrid">
            <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #666;">
                <i class="fa-solid fa-spinner fa-spin"></i> Loading timetables...
            </div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

        // 1. CONFIGURATION
        const SUPABASE_URL = "https://dzotwozhcxzkxtunmqth.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR6b3R3b3poY3h6a3h0dW5tcXRoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwODk5NzAsImV4cCI6MjA3MDY2NTk3MH0.KJfkrRq46c_Fo7ujkmvcue4jQAzIaSDfO3bU7YqMZdE";
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Global State
        let globalData = {
            classes: [],
            subjects: [],
            configs: [],
            entries: []
        };

        // 2. INITIALIZATION
        document.addEventListener('DOMContentLoaded', loadAllTimetableData);

        // 3. FETCH DATA
        async function loadAllTimetableData() {
            try {
                // Fetch all necessary tables in parallel
                const [configs, classes, subjects, entries] = await Promise.all([
                    supabase.from('schedule_configs').select('*'),
                    supabase.from('Classes').select('*'),
                    supabase.from('Subjects').select('*'),
                    supabase.from('timetable_entries').select('*')
                ]);

                if (configs.error) throw configs.error;
                
                // Store in global state
                globalData.configs = configs.data || [];
                globalData.classes = classes.data || [];
                globalData.subjects = subjects.data || [];
                globalData.entries = entries.data || [];

                renderTimetables();

            } catch (error) {
                console.error("Error loading data:", error);
                document.getElementById('timetablesGrid').innerHTML = 
                    `<div style="color: red; text-align: center;">Error loading timetables: ${error.message}</div>`;
            }
        }

        // 4. RENDER LOGIC
        function renderTimetables() {
            const container = document.getElementById('timetablesGrid');
            container.innerHTML = ''; // Clear loading spinner

            if (globalData.configs.length === 0) {
                container.innerHTML = '<div style="text-align: center;">No timetables found. Create one to get started!</div>';
                return;
            }

            // Loop through each "Config" (which represents one Class's schedule)
            globalData.configs.forEach(config => {
                const classInfo = globalData.classes.find(c => c.class_id === config.class_id);
                const classEntries = globalData.entries.filter(e => e.class_id === config.class_id);
                
                // Generate the HTML for this specific card
                const cardHTML = createTimetableCard(config, classInfo, classEntries);
                container.insertAdjacentHTML('beforeend', cardHTML);
            });
        }

        // 5. CARD GENERATOR
        function createTimetableCard(config, classInfo, entries) {
            const className = classInfo ? `${classInfo.class_name} ${classInfo.section || ''}` : `Class ${config.class_id}`;
            const subtitle = classInfo ? `Grade ${classInfo.grade_level || ''} â€¢ Room ${classInfo.room_number || 'TBD'}` : 'Schedule';

            // Generate time rows based on start_time and duration
            const rowsHTML = generateTimeRows(config, entries);

            return `
                <div class="timetable-card">
                    <div class="timetable-header">
                        <h3 class="timetable-title">${className}</h3>
                        <p class="timetable-subtitle">${subtitle}</p>
                    </div>
                    <div class="schedule-grid">
                        <table class="timetable-table">
                            <thead>
                                <tr>
                                    <th class="time-column">Time</th>
                                    <th class="day-column">Mon</th>
                                    <th class="day-column">Tue</th>
                                    <th class="day-column">Wed</th>
                                    <th class="day-column">Thu</th>
                                    <th class="day-column">Fri</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${rowsHTML}
                            </tbody>
                        </table>
                    </div>
                    <div class="card-footer">
                        <button class="btn-view" onclick="viewFullTimetable('${config.class_id}')">View Full</button>
                        <button class="btn-edit" onclick="editTimetable('${config.class_id}')">
                            <i class="fa-solid fa-pen"></i>
                        </button>
                    </div>
                </div>
            `;
        }

        // 6. DYNAMIC ROW GENERATOR
        function generateTimeRows(config, entries) {
            let html = '';
            
            // Default to 8 periods if not specified
            const periodsCount = config.periods_per_day || 8;
            const duration = config.period_duration || 40;
            
            // Parse Start Time (e.g., "08:00:00")
            let [startHour, startMin] = (config.start_time || "08:00").split(':').map(Number);
            let currentMinutes = startHour * 60 + startMin;

            // Generate a row for each period
            for (let i = 0; i < periodsCount; i++) {
                // Calculate time string (e.g., "08:00")
                const timeStr = minutesToTimeString(currentMinutes);
                
                // Generate cells for Mon-Fri
                const daysHTML = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'].map(day => {
                    return generateCell(day, timeStr, entries);
                }).join('');

                html += `
                    <tr class="time-row">
                        <td class="time-cell">${timeStr}</td>
                        ${daysHTML}
                    </tr>
                `;

                // Increment time
                currentMinutes += duration;
                
                // Optional: Add break logic here if you store breaks in DB
                if (i === 3) currentMinutes += 20; // Example: 20 min break after 4th period
            }
            return html;
        }

        // 7. CELL GENERATOR
        function generateCell(day, timeStr, entries) {
            // Find entry for this Day and Time
            // Note: We use startsWith because DB time might be "08:00:00" and calc time is "08:00"
            const entry = entries.find(e => 
                e.day_of_week === day && 
                e.start_time.startsWith(timeStr)
            );

            if (entry) {
                // Find Subject Code
                const subject = globalData.subjects.find(s => s.subject_id === entry.subject_id);
                const code = subject ? (subject.subject_code || subject.subject_name.substring(0,3).toUpperCase()) : '???';
                
                // Color coding based on subject (optional hash function)
                return `<td class="subject-cell">
                            <span class="subject-block" data-subject="${code}">${code}</span>
                        </td>`;
            } else {
                return `<td class="empty-cell"></td>`;
            }
        }

        // Helper: Convert minutes (480) to "08:00"
        function minutesToTimeString(totalMinutes) {
            const h = Math.floor(totalMinutes / 60);
            const m = totalMinutes % 60;
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
        }

        // --- EXPOSE FUNCTIONS TO WINDOW FOR BUTTONS ---
        window.editTimetable = (classId) => {
            window.location.href = `./create_timetable_setup.html?classId=${classId}`;
        };

        window.viewFullTimetable = (classId) => {
            alert(`View full details for Class ID: ${classId} (Feature coming soon)`);
        };
        
        // Sidebar Toggle
        const sidebar = document.querySelector('[data-sideBar]');
        const sidebarOpenBtn = document.querySelector('[data-sideBarOpen]');
        const sidebarCloseBtn = document.querySelector('[data-sideBarClose]');

        if (sidebarOpenBtn && sidebar) {
            sidebarOpenBtn.addEventListener('click', () => sidebar.classList.add('show'));
        }
        if (sidebarCloseBtn && sidebar) {
            sidebarCloseBtn.addEventListener('click', () => sidebar.classList.remove('show'));
        }
    </script>
</body>
</html>